<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krienen Lab Data Logger</title>

    <!-- DNA Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß¨</text></svg>">

    <style>
        /* [unchanged styles truncated for brevity ‚Äì use exactly what I gave before] */
        /* Keep the same CSS from the previous full index.html version */
    </style>
</head>
<body>
    <!-- Counter Badge -->
    <button id="counter-badge" class="counter-badge" onclick="editCounter()">
        104
    </button>

    <div class="header">
        <h1>Krienen Lab Data Logger</h1>
    </div>

    <div class="container">
        <!-- Auto-save controls -->
        <div class="save-controls">
            <button type="button" onclick="saveFormData()" class="save-btn">üíæ Save Progress</button>
            <button type="button" onclick="loadFormData()" class="save-btn">üìÅ Load Saved</button>
            <button type="button" onclick="clearSavedData()" class="save-btn">üóëÔ∏è Clear Saved</button>
            <span id="save-status" class="save-status">Auto-save enabled</span>
        </div>

        <form id="dataForm">
            <div class="tabs">
                <div class="tab active" onclick="showTab('tissue')">Tissue</div>
                <div class="tab" onclick="showTab('facs')">FACS</div>
                <div class="tab" onclick="showTab('cdna')">cDNA</div>
                <div class="tab" onclick="showTab('libraries')">Libraries</div>
            </div>

            <!-- Tissue Tab -->
            <div id="tissue" class="tab-content active">
                <div class="form-row">
                    <label for="project">Project:</label>
                    <select name="project" id="project" onchange="toggleProjectName()">
                        <option value="HMBA_CjAtlas_Subcortex">HMBA_CjAtlas_Subcortex</option>
                        <option value="HMBA_CjAtlas_Cortex">HMBA_CjAtlas_Cortex</option>
                        <option value="Aim 4">Aim 4</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-row" id="project-name-row" style="display: none;">
                    <label for="project_name">Project Name:</label>
                    <input type="text" name="project_name" id="project_name">
                </div>

                <div class="form-row">
                    <label for="experiment_date">Experiment Date:</label>
                    <input type="text" name="experiment_date" id="experiment_date" placeholder="YYMMDD or MM/DD/YY" required>
                </div>

                <div class="form-row">
                    <label for="marmoset_name">Marmoset Name:</label>
                    <select name="marmoset_name" id="marmoset_name" required>
                        <option value="">Select Marmoset</option>
                        <option value="Croissant">Croissant</option>
                        <option value="Nutmeg">Nutmeg</option>
                        <option value="Jellybean">Jellybean</option>
                        <option value="Rambo">Rambo</option>
                        <option value="Morel">Morel</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="hemisphere">Hemisphere:</label>
                    <select name="hemisphere" id="hemisphere" required>
                        <option value="">Select Hemisphere</option>
                        <option value="Left (LH)">Left (LH)</option>
                        <option value="Right (RH)">Right (RH)</option>
                        <option value="Both">Both</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="tile_location">Tile Location:</label>
                    <select name="tile_location" id="tile_location" required>
                        <option value="">Select Location</option>
                        <option value="BS">BS</option>
                        <option value="CX">CX</option>
                        <option value="CB">CB</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="slab_number">Slab Number:</label>
                    <input type="text" name="slab_number" id="slab_number"
                           placeholder="Enter numeric or comma-separated values (e.g., 9,10,11)" required>
                </div>

                <div class="form-row">
                    <label for="tile_number">Tile Number:</label>
                    <input type="text" name="tile_number" id="tile_number" placeholder="Enter numeric or alphanumeric value" required>
                </div>

                <div class="form-row">
                    <label for="elab_link">eLab Link:</label>
                    <div class="elab-group">
                        <input type="url" name="elab_link" id="elab_link" placeholder="eLab link will appear here">
                        <button type="button" class="paste-btn" onclick="pasteElabLink()">üìã Paste</button>
                    </div>
                </div>
            </div>

            <!-- FACS Tab -->
            <div id="facs" class="tab-content">
                <div class="form-row">
                    <label for="sorter_initials">Sorter Initials:</label>
                    <input type="text" name="sorter_initials" id="sorter_initials" placeholder="Enter sorter's initials" required>
                </div>

                <div class="form-row">
                    <label for="sort_method">Sort Method:</label>
                    <select name="sort_method" id="sort_method" onchange="updateFacsPopulation()" required>
                        <option value="">Select Method</option>
                        <option value="pooled">pooled</option>
                        <option value="unsorted">unsorted</option>
                        <option value="DAPI">DAPI</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="facs_population">FACS Population:</label>
                    <input type="text" name="facs_population" id="facs_population" placeholder="Format: XX/XX/XX (e.g., 70/20/10)">
                </div>

                <div class="form-row">
                    <label for="rxn_number">Number of Reactions:</label>
                    <input type="number" name="rxn_number" id="rxn_number" placeholder="Enter number of reactions" required>
                </div>

                <div class="form-row">
                    <label for="expected_recovery">Expected Recovery:</label>
                    <input type="number" name="expected_recovery" id="expected_recovery" placeholder="Enter expected recovery">
                </div>

                <div class="form-row">
                    <label for="nuclei_concentration">Nuclei Concentration:</label>
                    <input type="number" step="0.01" name="nuclei_concentration" id="nuclei_concentration" placeholder="Enter concentration">
                </div>

                <div class="form-row">
                    <label for="nuclei_volume">Nuclei Volume (¬µL):</label>
                    <input type="number" step="0.01" name="nuclei_volume" id="nuclei_volume" placeholder="Enter volume">
                </div>
            </div>

            <!-- cDNA Tab -->
            <div id="cdna" class="tab-content">
                <div class="form-row">
                    <label for="atac_prep_date">ATAC Library Prep Date:</label>
                    <input type="text" class="atac-field" name="atac_prep_date" id="atac_prep_date" placeholder="YYMMDD or MM/DD/YY">
                </div>

                <div class="form-row">
                    <label for="cdna_amp_date">cDNA Amplification Date:</label>
                    <input type="text" name="cdna_amp_date" id="cdna_amp_date" placeholder="YYMMDD or MM/DD/YY">
                </div>

                <div class="form-row">
                    <label for="rna_prep_date">cDNA Library Prep Date:</label>
                    <input type="text" name="rna_prep_date" id="rna_prep_date" placeholder="YYMMDD or MM/DD/YY">
                </div>

                <div class="form-row">
                    <label for="cdna_pcr_cycles">cDNA PCR Cycles:</label>
                    <input type="text" name="cdna_pcr_cycles" id="cdna_pcr_cycles" placeholder="Comma-separated values">
                </div>

                <div class="form-row">
                    <label for="cdna_concentration">cDNA Concentration:</label>
                    <input type="text" name="cdna_concentration" id="cdna_concentration" placeholder="Comma-separated values (ng/¬µL)">
                </div>

                <div class="form-row">
                    <label for="percent_cdna_400bp">Percent cDNA > 400bp:</label>
                    <input type="text" name="percent_cdna_400bp" id="percent_cdna_400bp" placeholder="Comma-separated values">
                </div>
            </div>

            <!-- Libraries Tab -->
            <div id="libraries" class="tab-content">
                <div class="form-row">
                    <label for="atac_indices">ATAC Indices:</label>
                    <input type="text" class="atac-field" name="atac_indices" id="atac_indices" placeholder="Comma-separated values (e.g., D4,E5,F6)">
                </div>

                <div class="form-row">
                    <label for="library_cycles_atac">ATAC Library Cycles:</label>
                    <input type="text" class="atac-field" name="library_cycles_atac" id="library_cycles_atac" placeholder="Comma-separated values">
                </div>

                <div class="form-row">
                    <label for="atac_lib_concentration">ATAC Library Concentration:</label>
                    <input type="text" class="atac-field" name="atac_lib_concentration" id="atac_lib_concentration" placeholder="Comma-separated values (ng/¬µL)">
                </div>

                <div class="form-row">
                    <label for="atac_sizes">ATAC Library Sizes (bp):</label>
                    <input type="text" class="atac-field" name="atac_sizes" id="atac_sizes" placeholder="Comma-separated values">
                </div>

                <div class="form-row">
                    <label for="rna_indices">cDNA Indices:</label>
                    <input type="text" name="rna_indices" id="rna_indices" placeholder="Comma-separated values (e.g., A1,B2,C3)">
                </div>

                <div class="form-row">
                    <label for="library_cycles_rna">cDNA Library Cycles:</label>
                    <input type="text" name="library_cycles_rna" id="library_cycles_rna" placeholder="Comma-separated values">
                </div>

                <div class="form-row">
                    <label for="rna_lib_concentration">cDNA Library Concentration:</label>
                    <input type="text" name="rna_lib_concentration" id="rna_lib_concentration" placeholder="Comma-separated values (ng/¬µL)">
                </div>

                <div class="form-row">
                    <label for="rna_sizes">cDNA Library Sizes (bp):</label>
                    <input type="text" name="rna_sizes" id="rna_sizes" placeholder="Comma-separated values">
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="submit-btn">üìä Submit Data</button>
                <button type="button" class="download-btn" onclick="downloadExcel()">üì• Download Excel</button>
            </div>
        </form>
    </div>

    <script>
        // Tab functionality
        function showTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Enable/disable ATAC fields depending on project
        function updateAtacFieldsForProject() {
            const projectSelect = document.getElementById('project');
            const atacFields = document.querySelectorAll('.atac-field');
            const isAim4 = projectSelect.value === 'Aim 4';

            atacFields.forEach(field => {
                field.disabled = isAim4;
                field.readOnly = isAim4;
                if (isAim4) {
                    field.value = '';  // clear any previous ATAC values for Aim 4
                }
            });
        }

        // Project name toggle + slab behavior + ATAC behavior
        function toggleProjectName() {
            const projectSelect = document.getElementById('project');
            const projectNameRow = document.getElementById('project-name-row');
            const slabInput = document.getElementById('slab_number');

            if (projectSelect.value === 'Other') {
                projectNameRow.style.display = 'grid';
                document.getElementById('project_name').required = true;
            } else {
                projectNameRow.style.display = 'none';
                document.getElementById('project_name').required = false;
            }

            // Slab placeholder:
            if (projectSelect.value === 'HMBA_CjAtlas_Cortex') {
                // Cortex: allow multi-slab (backend will handle multi-slab)
                slabInput.placeholder = 'Enter numeric or comma-separated values (e.g., 9,10,11)';
            } else {
                // Aim 4 + Subcortex + Other: enforce single slab
                if (slabInput.value.includes(',')) {
                    slabInput.value = slabInput.value.split(',')[0].trim();
                }
                slabInput.placeholder = 'Enter a single numeric slab value';
            }

            updateAtacFieldsForProject();
        }

        // FACS population update (unchanged)
        function updateFacsPopulation() {
            const sortMethod = document.getElementById('sort_method').value;
            const facsPopulation = document.getElementById('facs_population');

            if (sortMethod === 'pooled') {
                facsPopulation.disabled = false;
                facsPopulation.placeholder = 'Format: XX/XX/XX (e.g., 70/20/10)';
                facsPopulation.value = '';
            } else if (sortMethod === 'unsorted') {
                facsPopulation.disabled = true;
                facsPopulation.value = 'no_FACS';
            } else if (sortMethod === 'DAPI') {
                facsPopulation.disabled = true;
                facsPopulation.value = 'DAPI';
            }

            saveFormData();
        }

        // [Counter badge, pasteElabLink, downloadExcel, auto-save, load/clearSavedData
        //  and validateForm remain exactly as in the previous full version,
        //  except for the slab submit guard which we keep unchanged.]

        // In validateForm, keep the slab submit guard:
        // if (formData.project !== 'HMBA_CjAtlas_Cortex' && formData.slab) {
        //     if (formData.slab.includes(',')) {
        //         formData.slab = formData.slab.split(',')[0].trim();
        //     }
        // }

        document.addEventListener('DOMContentLoaded', function() {
            loadCounterBadge();
            loadFormData();

            updateAtacFieldsForProject();
            toggleProjectName();

            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', saveFormData);
                input.addEventListener('change', saveFormData);
            });

            // Enforce slab rules while typing
            const projectSelect = document.getElementById('project');
            const slabInput = document.getElementById('slab_number');

            slabInput.addEventListener('input', function () {
                const project = projectSelect.value;

                if (project === 'HMBA_CjAtlas_Cortex') {
                    // Allow commas for Cortex
                    return;
                }

                // For non-Cortex projects, strip commas and anything after
                if (this.value.includes(',')) {
                    this.value = this.value.split(',')[0].trim();
                }
            });

            const form = document.getElementById('dataForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                validateForm(event);
            });

            const elabInput = document.getElementById('elab_link');
            elabInput.addEventListener('click', function() {
                this.readOnly = false;
                this.classList.add('elab-editable');
                this.placeholder = 'Enter or edit your eLab link here';
            });
            elabInput.addEventListener('input', function() {
                saveFormData();
            });
        });
    </script>
</body>
</html>